#!/bin/sh

# runs commands based on extention/shebang

file=$(readlink -f "$1")
dir=$(dirname "$file")
base="${file%.*}"
noext=$(basename "$base")

cd "$dir" || exit

textype() {
    command="pdflatex"
    (sed 5q "$file" | grep -i -q 'xelatex') && command="xelatex"
    $command --output-directory="$dir" "$base" &&
        grep -i addbibresource "$file" >/dev/null &&
        biber --input-directory "$dir" "$base" &&
        $command --output-directory="$dir" "$base" &&
        $command --output-directory="$dir" "$base"
}

case "$file" in
*\.ms) preconv "$file" | refer -PS -e |
    groff -me -ms -kept -T pdf >"$base".pdf ;;
*\.mom) preconv "$file" | refer -PS -e |
    groff -mom -kept -T pdf >"$base".pdf ;;
*\.[0-9]) preconv "$file" | refer -PS -e | groff -mandoc -T pdf >"$base".pdf ;;
*\.[rR]md) Rscript -e "rmarkdown::render('$file', quiet=TRUE)" ;;
*\.tex) textype "$file" ;;
*\.md) pandoc "$file" --pdf-engine=xelatex -o "$base".pdf ;;
*config.h) sudo make install ;;
*\.c) cc "$file" -o "$base" && "$base" ;;
*\.java) javac "$file" && java "$noext" ;;
*\.py) python "$file" ;;
*\.m) octave "$file" ;;
*\.scad) openscad -o "$base".stl "$file" ;;
*\.go) go run "$file" ;;
*\.sent) setsid sent "$file" 2>/dev/null & ;;
*) sed 1q "$file" | grep "^#!/" | sed "s/^#!//" | xargs -r -I % "$file" ;;
esac
