#!/bin/bash

##############################################################################
# Author  :  Erik Dubois
##############################################################################

# *****************************************************************************
# preamble
# *****************************************************************************
# source utility functions
. ./utils

# check if running with elevated privileges
check_su

# *****************************************************************************
# main
# *****************************************************************************
if is-installed pacman; then
    set -e
    numberofcores=$(grep -c ^processor /proc/cpuinfo)

    if [ "$numberofcores" -gt 1 ]; then
        echo "You have $numberofcores cores"
        echo "Changing the makeflags for $numberofcores cores"
        sed -i 's/#MAKEFLAGS="-j2"/MAKEFLAGS="-j'$(($numberofcores + 1))'"/g' /etc/makepkg.conf
        echo "Changing the compression settings for $numberofcores cores"
        sed -i 's/COMPRESSXZ=(xz -c -z -)/COMPRESSXZ=(xz -c -T '"$numberofcores"' -z -)/g' /etc/makepkg.conf
    else
        echo "No change."
    fi

    echo "################################################################"
    echo "###  All cores will be used during building and compression ####"
    echo "################################################################"
fi

#==============================================================================
# credits
#==============================================================================

# https://0x0.st/-7To
