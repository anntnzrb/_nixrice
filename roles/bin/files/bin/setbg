#!/bin/sh

# setbg --- Utility script to set a background/wallpaper.

# Commentary:

# Currently works for Xorg only.

# Code:

# variables
wp_path='/tmp/wallpaper.png'
feh_cmd='feh --no-fehbg --bg-scale'

# -----------------------------------------------------------------------------
# functions
# -----------------------------------------------------------------------------

installedp() {
    test -x "`command -v "${1}"`"
}

internetp() {
    ping -q -c 1 'example.com' >/dev/null 2>&1
}

runningp() {
    pgrep -x "${1}" >/dev/null
}

wallpaper_exists_p() {
    # **
    # Checks if there is already a downloaded wallpaper file.
    # *

    test -s "${wp_path}"
}

get_wp_net() {
    # **
    # Retrieves and sets a wallpaper from a given link.
    # *

    # retrieve online background only if net is available
    internetp || return

    get_screen_res() {
        # **
        # Retrieves the primmary connected screen's resolution.
        # *

        xrandr --current \
            | grep '*'   \
            | uniq       \
            | awk '{print $1}'
    }

    # variables
    res=`get_screen_res | sed 's/x/\//'`

    wget --no-hsts -q -O "${wp_path}" "https://unsplash.it/${res}/?nature"

    # set the wallpaper only if the file exists
    wallpaper_exists_p && ${feh_cmd} "${wp_path}"
}

pywal_update () {
    # **
    # Updates colors using pywal.
    # *

    # do nothing if 'pywal' is not installed
    installedp 'wal' || return

    rm -Rf "${HOME}/.cache/wal" # prevent cached files
    wal -q -i '/tmp/wallpaper.png'

    pywal_dwm
}

pywal_dwm() {
    # **
    # Copies pywal's dwm configuration to '/tmp/' so my custom build of dwm can
    # read it.
    # *

    # do nothing if 'dwm' is not running
    runningp 'dwm' || return

    cp "${HOME}/.cache/wal/colors-wal-dwm.h" '/tmp/colors-wal-dwm.h'

    # remove urgent colors (if no patch)
    sed -i.bak '/\[SchemeUrg\]/d' '/tmp/colors-wal-dwm.h'
}

# -----------------------------------------------------------------------------
# main
# -----------------------------------------------------------------------------

# checks
#! runningp 'Xorg' && printf "A Xorg session must be running\n" >2&1 \
#! installedp 'feh' && printf "'feh' is needed to run this script\n" >2&1 && exit 1

# get wallpaper from the internet as default if argv[1] is null
test -z "${1}" && get_wp_net

# if argv[1] is a file, set it as wallpaper
test -f "${1}" && ${feh_cmd} "${1}"

# if argv[1] is a directory, randomly pick a file from that directory and set
# is as wallpaper
test -d "${1}" && ${feh_cmd} -rz "${1}"

# update pywal
pywal_update

# REVIEW: pywal creates a ~/.fehbg (waiting for dev patch); remove it
{ sleep 10 && test -e "${HOME}/.fehbg" && rm -f "${HOME}/.fehbg"; } &
