#!/bin/sh

# setbg --- Utility script to set a background/wallpaper.

# dependencies
! installed-p 'feh' && err "'feh' is needed to run this script" && exit 1

# variables
wp_path='/tmp/wallpaper.png'
feh_cmd='feh --no-fehbg --bg-scale'

# -----------------------------------------------------------------------------
# functions
# -----------------------------------------------------------------------------

wallpaper_exists_p() {
    # **
    # Retrieves the primary connected screen's resolution.
    # *

    test -s "${wp_path}"
}

get_wp_net() {
    # **
    # Retrieves and sets a wallpaper from a given link.
    # *

    # retrieve online background only if net is available
    internet-p || return

    get_screen_res() {
        # **
        # Retrieves the primmary connected screen's resolution.
        # *

        xrandr --current \
            | grep '*'   \
            | uniq       \
            | awk '{print $1}'
    }

    # variables
    res=`get_screen_res | sed 's/x/\//'`

    wget -q -O "${wp_path}" "https://unsplash.it/${res}/?nature"

    # set the wallpaper only if the file exists
    wallpaper_exists_p && ${feh_cmd} "${wp_path}"
}

pywal_update () {
    # **
    # Updates colors using pywal.
    # *

    # do nothing if 'pywal' is not installed
    installed-p 'wal' || return

    rm -Rf "${HOME}/.cache/wal" # prevent cached files
    wal -q -i '/tmp/wallpaper.png'

    pywal_dwm
}

pywal_dwm() {
    # **
    # Copies pywal's dwm configuration to '/tmp/' so my custom build of dwm can
    # read it.
    # *

    # do nothing if 'dwm' is not running
    running-p 'dwm' || return

    cp "${HOME}/.cache/wal/colors-wal-dwm.h" '/tmp/colors-wal-dwm.h'

    # remove urgent colors (if no patch)
    sed -i.bak '/\[SchemeUrg\]/d' '/tmp/colors-wal-dwm.h'
}

# get wallpaper from the internet as default if argv[1] is null
test -z "${1}" && get_wp_net

# if argv[1] is a file, set it as wallpaper
test -f "${1}" && ${feh_cmd} "${1}"

# if argv[1] is a directory, randomly pick a file from that directory and set
# is as wallpaper
test -d "${1}" && ${feh_cmd} -rz "${1}"

# update pywal
pywal_update
